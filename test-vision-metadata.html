<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Vision Metadata</title>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .upload-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 6px;
        }
        input[type="file"] {
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            opacity: 0.9;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 6px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .error {
            background: #ffebee;
            border-left-color: #f44336;
        }
        .success {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }
        .results {
            margin-top: 30px;
            padding: 20px;
            background: #fafafa;
            border-radius: 6px;
        }
        .metadata-field {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .metadata-field strong {
            display: inline-block;
            width: 150px;
            color: #555;
        }
        .preview-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        .preview-images img {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñºÔ∏è Test Vision Metadata Extrakce</h1>
        
        <div class="upload-section">
            <h2>1. Nahrajte PDF soubor</h2>
            <input type="file" id="pdfFile" accept="application/pdf" />
            <button onclick="testConversion()">üîÑ Test: P≈ôev√©st na obr√°zky</button>
            <button onclick="testFullExtraction()">ü§ñ Test: Pln√° extrakce metadat</button>
        </div>

        <div id="status"></div>
        <div id="results"></div>
        <div id="preview"></div>
    </div>

    <script type="module">
        // Nastav√≠me PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.worker.min.js';

        // OpenAI API konfigurace
        const OPENAI_API_KEY = prompt('Zadejte v√°≈° OpenAI API kl√≠ƒç:') || '';
        const OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions';

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
        }

        function showResults(metadata) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.className = 'results';
            
            let html = '<h2>üìä Extrahovan√° metadata:</h2>';
            
            for (const [key, value] of Object.entries(metadata)) {
                if (value) {
                    const displayValue = Array.isArray(value) ? value.join(', ') : value;
                    html += `<div class="metadata-field">
                        <strong>${key}:</strong> ${displayValue}
                    </div>`;
                }
            }
            
            resultsDiv.innerHTML = html;
        }

        async function convertPdfToImages(pdfFile, maxPages = 10) {
            console.log('üìÑ Konvertuji PDF na obr√°zky...');
            
            const arrayBuffer = await pdfFile.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            
            console.log(`üìä PDF m√° ${pdf.numPages} str√°nek`);
            
            const pagesToProcess = Math.min(maxPages, pdf.numPages);
            const images = [];
            
            for (let pageNum = 1; pageNum <= pagesToProcess; pageNum++) {
                showStatus(`üîÑ Zpracov√°v√°m str√°nku ${pageNum}/${pagesToProcess}...`);
                
                const page = await pdf.getPage(pageNum);
                const viewport = page.getViewport({ scale: 2.0 });
                
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                
                await page.render({ canvasContext: context, viewport: viewport }).promise;
                
                const base64Data = canvas.toDataURL('image/png').split(',')[1];
                
                images.push({
                    page_number: pageNum,
                    base64_png: base64Data,
                    dataUrl: canvas.toDataURL('image/png')
                });
                
                console.log(`‚úÖ Str√°nka ${pageNum} p≈ôevedena (${Math.round(base64Data.length / 1024)} KB)`);
            }
            
            return images;
        }

        async function extractMetadataWithVision(images, fileName) {
            console.log('ü§ñ Odes√≠l√°m do vision LLM...');
            
            const systemPrompt = `Jsi odborn√Ω asistent pro anal√Ωzu dokument≈Ø. Dostane≈° obr√°zky prvn√≠ch str√°nek PDF dokumentu.

TV≈ÆJ √öKOL:
Analyzuj text a informace viditeln√© na obr√°zc√≠ch a extrahuj n√°sleduj√≠c√≠ metadata:
- title: N√°zev publikace
- author: Autor/auto≈ôi
- publicationYear: Rok prvn√≠ho vyd√°n√≠ (pouze ƒç√≠slo)
- publisher: Nakladatelstv√≠
- language: Jazyk dokumentu (v ƒçe≈°tinƒõ)
- summary: Struƒçn√© shrnut√≠ (2-3 vƒõty)
- keywords: 5-7 kl√≠ƒçov√Ωch slov (v ƒçe≈°tinƒõ)
- releaseVersion: Verze vyd√°n√≠

PRAVIDLA:
1. Pou≈æ√≠vej POUZE informace z obr√°zk≈Ø
2. Pokud nƒõco nenajde≈°, vynech to
3. Pro summary: Buƒè konkr√©tn√≠
4. Pro language: Nikdy "nezn√°m√Ω"

FORM√ÅT: Pouze validn√≠ JSON:
{
  "title": "...",
  "author": "...",
  "publicationYear": 2023,
  "publisher": "...",
  "language": "...",
  "summary": "...",
  "keywords": ["...", "..."],
  "releaseVersion": "..."
}`;

            const content = [
                { type: 'text', text: `Analyzuj prvn√≠ch ${images.length} str√°nek dokumentu "${fileName}".` }
            ];

            for (const img of images) {
                content.push({
                    type: 'image_url',
                    image_url: { url: `data:image/png;base64,${img.base64_png}` }
                });
            }

            const response = await fetch(OPENAI_API_URL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${OPENAI_API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: content }
                    ],
                    max_tokens: 2000,
                    temperature: 0.3
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(`API error: ${error.error?.message || response.statusText}`);
            }

            const data = await response.json();
            const responseText = data.choices[0].message.content.trim();
            
            console.log('üìÑ Vision LLM odpovƒõƒè:', responseText);
            
            // Parsujeme JSON
            let jsonText = responseText;
            const jsonMatch = responseText.match(/```(?:json)?\s*(\{[\s\S]*\})\s*```/);
            if (jsonMatch) {
                jsonText = jsonMatch[1];
            }
            
            return JSON.parse(jsonText);
        }

        window.testConversion = async function() {
            const fileInput = document.getElementById('pdfFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Nejd≈ô√≠ve vyberte PDF soubor!');
                return;
            }
            
            try {
                showStatus('üîÑ P≈ôev√°d√≠m PDF na obr√°zky...', 'info');
                
                const images = await convertPdfToImages(file, 10);
                
                showStatus(`‚úÖ √öspƒõ≈°nƒõ p≈ôevedeno ${images.length} str√°nek!`, 'success');
                
                // Zobraz√≠me preview
                const previewDiv = document.getElementById('preview');
                previewDiv.innerHTML = '<h2>üñºÔ∏è Preview prvn√≠ch str√°nek:</h2><div class="preview-images">' +
                    images.map(img => `<img src="${img.dataUrl}" alt="Str√°nka ${img.page_number}" />`).join('') +
                    '</div>';
                
            } catch (error) {
                console.error(error);
                showStatus(`‚ùå Chyba: ${error.message}`, 'error');
            }
        };

        window.testFullExtraction = async function() {
            const fileInput = document.getElementById('pdfFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Nejd≈ô√≠ve vyberte PDF soubor!');
                return;
            }
            
            try {
                showStatus('üîÑ Krok 1/2: P≈ôev√°d√≠m PDF na obr√°zky...', 'info');
                const images = await convertPdfToImages(file, 10);
                
                showStatus(`‚úÖ P≈ôevedeno ${images.length} str√°nek<br/>üîÑ Krok 2/2: Odes√≠l√°m do vision LLM...`, 'info');
                const metadata = await extractMetadataWithVision(images, file.name);
                
                showStatus('‚úÖ Metadata √∫spƒõ≈°nƒõ extrahov√°na!', 'success');
                showResults(metadata);
                
                // Zobraz√≠me i preview
                const previewDiv = document.getElementById('preview');
                previewDiv.innerHTML = '<h2>üñºÔ∏è Analyzovan√© str√°nky:</h2><div class="preview-images">' +
                    images.slice(0, 3).map(img => `<img src="${img.dataUrl}" alt="Str√°nka ${img.page_number}" />`).join('') +
                    '</div>';
                
            } catch (error) {
                console.error(error);
                showStatus(`‚ùå Chyba: ${error.message}`, 'error');
            }
        };
    </script>
</body>
</html>

