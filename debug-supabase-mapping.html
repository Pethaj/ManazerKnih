<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Supabase Mapov√°n√≠</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .debug-header {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .test-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.2s;
        }
        .test-button:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            min-height: 100px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        .results.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .results.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .results.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 12px;
        }
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .comparison-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .status-ok { background-color: #d4edda; }
        .status-warning { background-color: #fff3cd; }
        .status-error { background-color: #f8d7da; }
    </style>
</head>
<body>
    <div class="debug-header">
        <h1>üîç Debug Supabase Mapov√°n√≠</h1>
        <p>Diagnostika proƒç se data z Supabase neprop√≠≈°ou do carouselu</p>
    </div>

    <div class="debug-container">
        <div class="test-section">
            <h2>1. üéØ Test specifick√Ωch ID z webhooku</h2>
            <p>Testuje p≈ôesnƒõ ta ID, kter√° webhook vrac√≠: 1002318245, 1002737245, 1002324245</p>
            
            <button id="testWebhookIds" class="test-button">Test Webhook ID</button>
            <div id="webhookIdsResults" class="results info">Kliknƒõte na tlaƒç√≠tko pro test...</div>
        </div>

        <div class="test-section">
            <h2>2. üîç Simulace hybridn√≠ho procesu</h2>
            <p>Kompletn√≠ simulace toho, co dƒõl√° hybridn√≠ syst√©m krok za krokem</p>
            
            <button id="testHybridProcess" class="test-button">Simulovat Hybridn√≠ Proces</button>
            <div id="hybridProcessResults" class="results info">Kliknƒõte na tlaƒç√≠tko pro simulaci...</div>
        </div>

        <div class="test-section">
            <h2>3. üìä Porovn√°n√≠ oƒçek√°van√Ωch vs skuteƒçn√Ωch dat</h2>
            <p>Zobraz√≠ side-by-side porovn√°n√≠ toho, co webhook oƒçek√°v√° vs co Supabase vrac√≠</p>
            
            <button id="testDataComparison" class="test-button">Porovnat Data</button>
            <div id="dataComparisonResults" class="results info">Kliknƒõte na tlaƒç√≠tko pro porovn√°n√≠...</div>
        </div>

        <div class="test-section">
            <h2>4. üõ†Ô∏è Test mapov√°n√≠ na carousel form√°t</h2>
            <p>Testuje konverzi Supabase dat na form√°t pou≈æiteln√Ω v carouselu</p>
            
            <button id="testCarouselMapping" class="test-button">Test Carousel Mapov√°n√≠</button>
            <div id="carouselMappingResults" class="results info">Kliknƒõte na tlaƒç√≠tko pro test mapov√°n√≠...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase konfigurace
        const SUPABASE_URL = 'https://umxkjdllhlkclrplxdxx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVteGtqZGxsaGxrY2xycGx4ZHh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjEyMzM0MTMsImV4cCI6MjAzNjgwOTQxM30.MKSjLqO1YMGwGOdZIttWOwrCaQTSHkf6Fc-9XQbQ8t0';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ID z webhook testu
        const WEBHOOK_IDS = ['1002318245', '1002737245', '1002324245'];

        function showResults(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `results ${type}`;
            element.textContent = content;
        }

        function showResultsHTML(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `results ${type}`;
            element.innerHTML = content;
        }

        // Test 1: Specifick√° ID z webhooku
        document.getElementById('testWebhookIds').addEventListener('click', async () => {
            showResults('webhookIdsResults', 'üîÑ Testuji specifick√° ID z webhooku...');
            
            try {
                let result = `üéØ TEST WEBHOOK ID v SUPABASE\n`;
                result += `${'='.repeat(50)}\n\n`;
                result += `Hled√°m ID: ${WEBHOOK_IDS.join(', ')}\n\n`;

                // P≈ôesnƒõ stejn√Ω dotaz jako v hybrid service
                const { data, error } = await supabase
                    .from('products')
                    .select('*')
                    .in('product_code', WEBHOOK_IDS);

                if (error) {
                    throw error;
                }

                result += `üìä V√ùSLEDKY DOTAZU:\n`;
                result += `Nalezeno produkt≈Ø: ${data?.length || 0}/${WEBHOOK_IDS.length}\n\n`;

                if (data && data.length > 0) {
                    result += `DETAILY NALEZEN√ùCH PRODUKT≈Æ:\n`;
                    result += `${'-'.repeat(60)}\n`;

                    data.forEach((product, index) => {
                        result += `\n${index + 1}. PRODUKT ID: ${product.product_code}\n`;
                        result += `   üìù N√°zev: ${product.name || 'CHYB√ç'}\n`;
                        result += `   üí∞ Cena: ${product.price || 'CHYB√ç'} ${product.currency || 'N/A'}\n`;
                        result += `   üîó URL: ${product.product_url ? 'M√°' : 'CHYB√ç'}\n`;
                        result += `   üñºÔ∏è Obr√°zek: ${product.image_url ? 'M√°' : 'CHYB√ç'}\n`;
                        result += `   üè∑Ô∏è Kategorie: ${product.category || 'CHYB√ç'}\n`;
                        
                        // Kontrola datov√Ωch typ≈Ø
                        result += `   üî¨ Data typy:\n`;
                        result += `      - price: ${typeof product.price} (${product.price})\n`;
                        result += `      - name: ${typeof product.name} (d√©lka: ${product.name?.length || 0})\n`;
                        result += `      - product_url: ${typeof product.product_url} (d√©lka: ${product.product_url?.length || 0})\n`;
                        result += `      - image_url: ${typeof product.image_url} (d√©lka: ${product.image_url?.length || 0})\n`;
                    });

                    // Kontrola chybƒõj√≠c√≠ch ID
                    const foundIds = data.map(p => p.product_code);
                    const missingIds = WEBHOOK_IDS.filter(id => !foundIds.includes(id));
                    
                    if (missingIds.length > 0) {
                        result += `\n‚ùå CHYBƒöJ√çC√ç ID:\n`;
                        missingIds.forEach(id => {
                            result += `   - ${id}\n`;
                        });
                        result += `\nüí° ≈òE≈†EN√ç: P≈ôidejte chybƒõj√≠c√≠ produkty do tabulky\n`;
                    } else {
                        result += `\n‚úÖ V≈°echna webhook ID nalezena v Supabase!\n`;
                    }

                } else {
                    result += `‚ùå ≈Ω√ÅDN√â PRODUKTY NENALEZENY!\n\n`;
                    result += `MO≈ΩN√â P≈ò√çƒåINY:\n`;
                    result += `1. ID ${WEBHOOK_IDS.join(', ')} neexistuj√≠ v tabulce\n`;
                    result += `2. Sloupec product_code m√° jin√Ω form√°t\n`;
                    result += `3. Case-sensitive probl√©m\n\n`;
                    
                    // Zkus√≠me naj√≠t podobn√° ID
                    const { data: allProducts } = await supabase
                        .from('products')
                        .select('product_code')
                        .limit(10);
                    
                    if (allProducts && allProducts.length > 0) {
                        result += `UK√ÅZKA EXISTUJ√çC√çCH ID:\n`;
                        allProducts.forEach(p => {
                            result += `   - ${p.product_code}\n`;
                        });
                    }
                }

                showResults('webhookIdsResults', result, data && data.length > 0 ? 'success' : 'error');

            } catch (error) {
                showResults('webhookIdsResults', 
                    `‚ùå CHYBA PRI TESTU WEBHOOK ID!\n\nError: ${error.message}\nCode: ${error.code}`, 
                    'error');
            }
        });

        // Test 2: Simulace hybridn√≠ho procesu
        document.getElementById('testHybridProcess').addEventListener('click', async () => {
            showResults('hybridProcessResults', 'üîÑ Simuluji hybridn√≠ proces...');
            
            try {
                let result = `üöÄ SIMULACE HYBRIDN√çHO PROCESU\n`;
                result += `${'='.repeat(50)}\n\n`;

                // Krok 1: Simulace webhook odpovƒõdi
                result += `üì° KROK 1: Webhook odpovƒõƒè (simulov√°no)\n`;
                const mockWebhookProducts = [
                    { id: '1002318245', recommendation: 'V√Ωborn√Ω pro bolesti kloub≈Ø' },
                    { id: '1002737245', recommendation: 'Pom√°h√° p≈ôi z√°nƒõtech' },
                    { id: '1002324245', recommendation: 'Ochrana p≈ôed chladem' }
                ];
                result += `Webhook vr√°til ${mockWebhookProducts.length} doporuƒçen√≠\n`;
                mockWebhookProducts.forEach((wp, i) => {
                    result += `   ${i+1}. ID: ${wp.id}, Doporuƒçen√≠: ${wp.recommendation}\n`;
                });

                // Krok 2: Supabase dotaz
                result += `\nüóÑÔ∏è KROK 2: Supabase dotaz\n`;
                const productIds = mockWebhookProducts.map(wp => wp.id);
                result += `Hled√°m ID: ${productIds.join(', ')}\n`;

                const { data: supabaseProducts, error } = await supabase
                    .from('products')
                    .select('*')
                    .in('product_code', productIds);

                if (error) {
                    throw error;
                }

                result += `Supabase vr√°til: ${supabaseProducts?.length || 0} produkt≈Ø\n`;

                // Krok 3: Kombinov√°n√≠
                result += `\nüîó KROK 3: Kombinov√°n√≠ dat\n`;
                const combinedProducts = [];

                mockWebhookProducts.forEach((webhookProduct, index) => {
                    const supabaseProduct = supabaseProducts?.find(sp => sp.product_code === webhookProduct.id);
                    
                    if (supabaseProduct) {
                        // Simulace mapov√°n√≠ z hybrid service
                        const cleanedPrice = supabaseProduct.price !== null && supabaseProduct.price !== undefined
                            ? Number(supabaseProduct.price) : null;
                        
                        const combined = {
                            id: index + 1,
                            product_code: supabaseProduct.product_code,
                            product_name: supabaseProduct.name?.trim() || `BEWIT Produkt ${supabaseProduct.product_code}`,
                            description: webhookProduct.recommendation,
                            category: supabaseProduct.category?.trim() || 'Neza≈ôazeno',
                            price: cleanedPrice,
                            currency: supabaseProduct.currency?.trim() || 'CZK',
                            product_url: supabaseProduct.product_url?.trim() || null,
                            image_url: supabaseProduct.image_url?.trim() || null,
                            similarity_score: 0.9
                        };
                        
                        combinedProducts.push(combined);
                        
                        result += `‚úÖ Kombinov√°n: ${combined.product_name}\n`;
                        result += `   Cena: ${combined.price} ${combined.currency}\n`;
                        result += `   URL: ${combined.product_url ? 'Ano' : 'CHYB√ç'}\n`;
                        result += `   Obr√°zek: ${combined.image_url ? 'Ano' : 'CHYB√ç'}\n`;
                        
                    } else {
                        result += `‚ùå Produkt ${webhookProduct.id} nenalezen v Supabase\n`;
                    }
                });

                result += `\nüéØ FIN√ÅLN√ç V√ùSLEDEK:\n`;
                result += `Webhook produkty: ${mockWebhookProducts.length}\n`;
                result += `Supabase produkty: ${supabaseProducts?.length || 0}\n`;
                result += `Kombinovan√© produkty: ${combinedProducts.length}\n`;
                result += `Produkty s cenou: ${combinedProducts.filter(p => p.price !== null).length}\n`;
                result += `Produkty s URL: ${combinedProducts.filter(p => p.product_url).length}\n`;
                result += `Produkty s obr√°zkem: ${combinedProducts.filter(p => p.image_url).length}\n`;

                if (combinedProducts.length === 0) {
                    result += `\n‚ùå PROBL√âM: ≈Ω√°dn√© produkty nebyly zkombinovan√©!\n`;
                } else if (combinedProducts.filter(p => p.price === null).length > 0) {
                    result += `\n‚ö†Ô∏è VAROV√ÅN√ç: Nƒõkter√© produkty nemaj√≠ cenu!\n`;
                } else {
                    result += `\n‚úÖ V≈°e v po≈ô√°dku - v≈°echny produkty maj√≠ kompletn√≠ data!\n`;
                }

                showResults('hybridProcessResults', result, 
                    combinedProducts.length === mockWebhookProducts.length ? 'success' : 'error');

            } catch (error) {
                showResults('hybridProcessResults', 
                    `‚ùå CHYBA PRI SIMULACI!\n\nError: ${error.message}`, 
                    'error');
            }
        });

        // Test 3: Porovn√°n√≠ dat
        document.getElementById('testDataComparison').addEventListener('click', async () => {
            showResults('dataComparisonResults', 'üîÑ Porovn√°v√°m data...');
            
            try {
                const { data: supabaseProducts, error } = await supabase
                    .from('products')
                    .select('*')
                    .in('product_code', WEBHOOK_IDS);

                if (error) throw error;

                let html = `
                    <h3>üìä POROVN√ÅN√ç WEBHOOK vs SUPABASE DAT</h3>
                    <table class="comparison-table">
                        <tr>
                            <th>ID</th>
                            <th>Webhook Status</th>
                            <th>Supabase Status</th>
                            <th>N√°zev</th>
                            <th>Cena</th>
                            <th>URL</th>
                            <th>Obr√°zek</th>
                            <th>Diagn√≥za</th>
                        </tr>
                `;

                WEBHOOK_IDS.forEach(id => {
                    const supabaseProduct = supabaseProducts?.find(p => p.product_code === id);
                    const webhookStatus = '‚úÖ Oƒçek√°v√°no';
                    const supabaseStatus = supabaseProduct ? '‚úÖ Nalezeno' : '‚ùå Nenalezeno';
                    
                    const hasName = supabaseProduct?.name ? '‚úÖ' : '‚ùå';
                    const hasPrice = supabaseProduct?.price ? '‚úÖ' : '‚ùå';
                    const hasUrl = supabaseProduct?.product_url ? '‚úÖ' : '‚ùå';
                    const hasImage = supabaseProduct?.image_url ? '‚úÖ' : '‚ùå';
                    
                    let diagnosis = '';
                    let rowClass = '';
                    
                    if (!supabaseProduct) {
                        diagnosis = 'Produkt neexistuje v Supabase';
                        rowClass = 'status-error';
                    } else if (!supabaseProduct.name || !supabaseProduct.price || !supabaseProduct.product_url) {
                        diagnosis = 'Chyb√≠ kritick√° data';
                        rowClass = 'status-warning';
                    } else {
                        diagnosis = 'V≈°e v po≈ô√°dku';
                        rowClass = 'status-ok';
                    }

                    html += `
                        <tr class="${rowClass}">
                            <td>${id}</td>
                            <td>${webhookStatus}</td>
                            <td>${supabaseStatus}</td>
                            <td>${hasName} ${supabaseProduct?.name || 'N/A'}</td>
                            <td>${hasPrice} ${supabaseProduct?.price || 'N/A'}</td>
                            <td>${hasUrl} ${supabaseProduct?.product_url ? 'M√°' : 'Chyb√≠'}</td>
                            <td>${hasImage} ${supabaseProduct?.image_url ? 'M√°' : 'Chyb√≠'}</td>
                            <td>${diagnosis}</td>
                        </tr>
                    `;
                });

                html += `</table>`;

                // Shrnut√≠
                const foundCount = supabaseProducts?.length || 0;
                const completeCount = supabaseProducts?.filter(p => 
                    p.name && p.price && p.product_url && p.image_url
                ).length || 0;

                html += `
                    <h4>üìã SHRNUT√ç:</h4>
                    <ul>
                        <li>Webhook oƒçek√°v√°: ${WEBHOOK_IDS.length} produkt≈Ø</li>
                        <li>Supabase na≈°el: ${foundCount} produkt≈Ø</li>
                        <li>Kompletn√≠ produkty: ${completeCount} produkt≈Ø</li>
                        <li>√öspƒõ≈°nost: ${Math.round((completeCount / WEBHOOK_IDS.length) * 100)}%</li>
                    </ul>
                `;

                showResultsHTML('dataComparisonResults', html, 
                    completeCount === WEBHOOK_IDS.length ? 'success' : 'error');

            } catch (error) {
                showResults('dataComparisonResults', 
                    `‚ùå CHYBA PRI POROVN√ÅN√ç!\n\nError: ${error.message}`, 
                    'error');
            }
        });

        // Test 4: Carousel mapov√°n√≠
        document.getElementById('testCarouselMapping').addEventListener('click', async () => {
            showResults('carouselMappingResults', 'üîÑ Testuji carousel mapov√°n√≠...');
            
            try {
                const { data: supabaseProducts, error } = await supabase
                    .from('products')
                    .select('*')
                    .in('product_code', WEBHOOK_IDS);

                if (error) throw error;

                let result = `üõ†Ô∏è TEST CAROUSEL MAPOV√ÅN√ç\n`;
                result += `${'='.repeat(50)}\n\n`;

                if (!supabaseProducts || supabaseProducts.length === 0) {
                    result += `‚ùå ≈Ω√°dn√© produkty k mapov√°n√≠!\n`;
                    showResults('carouselMappingResults', result, 'error');
                    return;
                }

                result += `Mapuji ${supabaseProducts.length} produkt≈Ø na carousel form√°t...\n\n`;

                const carouselProducts = supabaseProducts.map((product, index) => {
                    // P≈ôesn√° simulace mapov√°n√≠ z hybrid service
                    const cleanedProductName = product.name && product.name.trim() !== '' 
                        ? product.name.trim()
                        : `BEWIT Produkt ${product.product_code}`;
                    
                    const cleanedPrice = product.price !== null && product.price !== undefined
                        ? Number(product.price)
                        : null;
                    
                    const cleanedCurrency = product.currency && product.currency.trim() !== ''
                        ? product.currency.trim()
                        : 'CZK';
                    
                    const cleanedProductUrl = product.product_url && product.product_url.trim() !== ''
                        ? product.product_url.trim()
                        : null;
                    
                    const cleanedImageUrl = product.image_url && product.image_url.trim() !== ''
                        ? product.image_url.trim()
                        : null;

                    return {
                        id: index + 1,
                        product_code: product.product_code,
                        product_name: cleanedProductName,
                        description: `AI doporuƒçen√≠ pro ${cleanedProductName}`,
                        category: product.category || 'Neza≈ôazeno',
                        price: cleanedPrice,
                        currency: cleanedCurrency,
                        product_url: cleanedProductUrl,
                        image_url: cleanedImageUrl,
                        similarity_score: 0.9
                    };
                });

                // Anal√Ωza mapovan√Ωch produkt≈Ø
                result += `V√ùSLEDKY MAPOV√ÅN√ç:\n`;
                result += `${'-'.repeat(40)}\n`;

                carouselProducts.forEach((cp, index) => {
                    result += `\n${index + 1}. ${cp.product_name}\n`;
                    result += `   üìã Code: ${cp.product_code}\n`;
                    result += `   üí∞ Cena: ${cp.price ? `${cp.price} ${cp.currency}` : 'CHYB√ç'}\n`;
                    result += `   üîó URL: ${cp.product_url ? 'OK' : 'CHYB√ç'}\n`;
                    result += `   üñºÔ∏è Obr√°zek: ${cp.image_url ? 'OK' : 'CHYB√ç'}\n`;
                    
                    // Validace pro carousel
                    const issues = [];
                    if (!cp.price) issues.push('Chyb√≠ cena');
                    if (!cp.product_url) issues.push('Chyb√≠ URL');
                    if (!cp.image_url) issues.push('Chyb√≠ obr√°zek');
                    
                    if (issues.length > 0) {
                        result += `   ‚ö†Ô∏è Probl√©my: ${issues.join(', ')}\n`;
                    } else {
                        result += `   ‚úÖ V≈°e OK pro carousel\n`;
                    }
                });

                // Statistiky
                const productsWithPrice = carouselProducts.filter(p => p.price !== null).length;
                const productsWithUrl = carouselProducts.filter(p => p.product_url !== null).length;
                const productsWithImage = carouselProducts.filter(p => p.image_url !== null).length;
                const completeProducts = carouselProducts.filter(p => 
                    p.price !== null && p.product_url !== null && p.image_url !== null
                ).length;

                result += `\nüìä STATISTIKY MAPOV√ÅN√ç:\n`;
                result += `Celkem produkt≈Ø: ${carouselProducts.length}\n`;
                result += `S cenou: ${productsWithPrice}/${carouselProducts.length}\n`;
                result += `S URL: ${productsWithUrl}/${carouselProducts.length}\n`;
                result += `S obr√°zkem: ${productsWithImage}/${carouselProducts.length}\n`;
                result += `Kompletn√≠: ${completeProducts}/${carouselProducts.length}\n`;

                result += `\nüéØ HODNOCEN√ç PRO CAROUSEL:\n`;
                if (completeProducts === carouselProducts.length) {
                    result += `‚úÖ Perfektn√≠ - v≈°echny produkty jsou p≈ôipraven√© pro carousel\n`;
                } else if (completeProducts > 0) {
                    result += `‚ö†Ô∏è ƒå√°steƒçn√© - ${carouselProducts.length - completeProducts} produkt≈Øm chyb√≠ data\n`;
                } else {
                    result += `‚ùå Kritick√© - ≈æ√°dn√Ω produkt nen√≠ p≈ôipraven√Ω pro carousel\n`;
                }

                // JSON v√Ωstup pro debugging
                result += `\nüìÑ JSON V√ùSTUP PRO DEBUGGING:\n`;
                result += JSON.stringify(carouselProducts, null, 2);

                showResults('carouselMappingResults', result, 
                    completeProducts === carouselProducts.length ? 'success' : 'error');

            } catch (error) {
                showResults('carouselMappingResults', 
                    `‚ùå CHYBA PRI CAROUSEL MAPOV√ÅN√ç!\n\nError: ${error.message}`, 
                    'error');
            }
        });

        // Automaticky spustit prvn√≠ test
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                document.getElementById('testWebhookIds').click();
            }, 1000);
        });
    </script>
</body>
</html>
