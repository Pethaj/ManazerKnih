const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/WaveLoader-DvqYMd3O.js","assets/preload-helper-B8tWKQ1F.js","assets/WaveLoader-MPqx-1mk.css"])))=>i.map(i=>d[i]);
import{d as k,r as d,b as C,e as E,j as t,C as P,W as R,L,P as I,M,c as z,f as W,g as S,i as O,p as T,R as $}from"./WaveLoader-DvqYMd3O.js";import{_ as D}from"./preload-helper-B8tWKQ1F.js";function F(){const e=new URLSearchParams(window.location.search);return{chatbotId:e.get("chatbot")||"vany_chat",theme:e.get("theme")||"light",greeting:e.get("greeting")||void 0,position:e.get("position")||"bottom-right",width:e.get("width")?parseInt(e.get("width")):400,height:e.get("height")?parseInt(e.get("height")):600}}function A(e,o){window.parent&&window.parent!==window&&window.parent.postMessage({type:e,...o},"*")}function B(e){window.addEventListener("message",o=>{var r,s,a,i;if(o.source!==window.parent)return;const n=o.data;switch(n.type){case"PARENT_OPEN":(r=e.onOpen)==null||r.call(e);break;case"PARENT_CLOSE":(s=e.onClose)==null||s.call(e);break;case"PARENT_SEND_MESSAGE":(a=e.onSendMessage)==null||a.call(e,n.message);break;case"PARENT_SET_THEME":(i=e.onSetTheme)==null||i.call(e,n.theme);break;default:console.log("ğŸ“¨ NeznÃ¡mÃ¡ zprÃ¡va z parent:",n)}})}function H(){A("WIDGET_READY"),console.log("âœ… Widget oznÃ¡mil parent window, Å¾e je pÅ™ipraven")}async function U(e){try{const{supabase:o}=await D(async()=>{const{supabase:s}=await import("./WaveLoader-DvqYMd3O.js").then(a=>a.q);return{supabase:s}},__vite__mapDeps([0,1,2])),{data:n,error:r}=await o.from("chatbot_settings").select("*").eq("chatbot_id",e).single();return r?(console.error("Error loading chatbot settings:",r),{chatbot_id:e,chatbot_name:"Vany Chat",product_recommendations:!0,product_button_recommendations:!0,book_database:!1,use_feed_1:!0,use_feed_2:!0,inline_product_links:!1,enable_product_router:!0,enable_manual_funnel:!1,webhook_url:"https://n8n.srv980546.hstgr.cloud/webhook/97dc857e-352b-47b4-91cb-bc134afc764c/chat"}):n}catch(o){return console.error("Failed to load chatbot settings:",o),null}}function V(e){const o=document.documentElement;e==="dark"?o.classList.add("dark"):o.classList.remove("dark"),console.log(`ğŸ¨ TÃ©ma nastaveno na: ${e}`)}function G(){try{return window.self!==window.top}catch{return!0}}function p(e,...o){console.log(`[Vany Widget] ${e}`,...o)}function j(e,...o){console.error(`[Vany Widget] ${e}`,...o)}const m=structuredClone(k);m.protocols&&m.protocols.href?m.protocols.href.push("product"):m.protocols?m.protocols.href=["http","https","mailto","product"]:m.protocols={href:["http","https","mailto","product"]};const q=e=>t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",...e,children:[t.jsx("line",{x1:"22",y1:"2",x2:"11",y2:"13"}),t.jsx("polygon",{points:"22 2 15 22 11 13 2 9 22 2"})]}),Z=e=>t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",...e,children:[t.jsx("path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"}),t.jsx("circle",{cx:"12",cy:"7",r:"4"})]}),v=e=>t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",...e,children:[t.jsx("path",{d:"M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"}),t.jsx("path",{d:"M12 2C6.477 2 2 6.477 2 12h10c5.523 0 10-4.477 10-10C17.523 2 12 2 12 2z"})]});function J(){return`widget-session-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const K=({message:e,chatbotSettings:o,sessionId:n,lastUserQuery:r})=>{const s=e.role==="user";return t.jsxs("div",{className:`flex items-start gap-3 mb-4 ${s?"flex-row-reverse":"flex-row"}`,children:[t.jsx("div",{className:`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${s?"bg-blue-500":"bg-green-500"}`,children:s?t.jsx(Z,{className:"w-5 h-5 text-white"}):t.jsx(v,{className:"w-5 h-5 text-white"})}),t.jsxs("div",{className:`flex-1 ${s?"text-right":"text-left"}`,children:[t.jsx("div",{className:`inline-block px-4 py-2 rounded-lg ${s?"bg-blue-500 text-white":"bg-white text-gray-800 border border-gray-200"}`,children:e.isFunnelMessage&&e.funnelProducts?t.jsx(I,{botResponse:e.text,funnelProducts:e.funnelProducts,symptomList:e.symptomList||[]}):t.jsx(M,{remarkPlugins:[S],rehypePlugins:[z,[W,m]],className:"prose prose-sm max-w-none",children:e.text})}),!s&&(o==null?void 0:o.product_button_recommendations)&&r&&!e.isFunnelMessage&&t.jsx("div",{className:"mt-2",children:t.jsx(O,{userQuery:r,botResponse:e.text,sessionId:n||""})})]})]})},Q=({messages:e,isLoading:o,chatbotSettings:n,sessionId:r})=>{const s=d.useRef(null);d.useEffect(()=>{var i;(i=s.current)==null||i.scrollIntoView({behavior:"smooth"})},[e,o]);const a=e.filter(i=>i.role==="user").pop();return t.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[e.map(i=>t.jsx(K,{message:i,chatbotSettings:n,sessionId:r,lastUserQuery:a==null?void 0:a.text},i.id)),o&&t.jsxs("div",{className:"flex items-start gap-3 mb-4",children:[t.jsx("div",{className:"flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center bg-green-500",children:t.jsx(v,{className:"w-5 h-5 text-white"})}),t.jsx("div",{className:"flex-1",children:t.jsxs("div",{className:"inline-block px-4 py-2 rounded-lg bg-white border border-gray-200",children:[t.jsx(R,{}),t.jsx(L,{})]})})]}),t.jsx("div",{ref:s})]})},Y=({onSendMessage:e,isLoading:o})=>{const[n,r]=d.useState(""),s=a=>{a.preventDefault(),n.trim()&&!o&&(e(n.trim()),r(""))};return t.jsxs("form",{onSubmit:s,className:"flex gap-2",children:[t.jsx("input",{type:"text",value:n,onChange:a=>r(a.target.value),placeholder:"NapiÅ¡te zprÃ¡vu...",disabled:o,className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"}),t.jsx("button",{type:"submit",disabled:o||!n.trim(),className:"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:t.jsx(q,{className:"w-5 h-5"})})]})},X=({config:e,chatbotSettings:o})=>{const[n,r]=d.useState([]),[s,a]=d.useState(!1),[i,y]=d.useState("");d.useEffect(()=>{y(J()),p("Widget Chat inicializovÃ¡n",{config:e,chatbotSettings:o}),H(),B({onSendMessage:c=>{p("PÅ™ijata zprÃ¡va z parent:",c),w(c)},onSetTheme:c=>{p("ZmÄ›na tÃ©matu z parent:",c)}}),e.greeting&&r([{id:"greeting",role:"bot",text:e.greeting}])},[]);const w=d.useCallback(async c=>{if(!c.trim()||s)return;const g={id:`user-${Date.now()}`,role:"user",text:c};r(x=>[...x,g]),a(!0);try{const x=n.map(u=>({id:u.id,role:u.role,text:u.text})),l=await C(c,x,i,{categories:[],labels:[],publication_types:[]});if(p("Intent routing result:",l),l.intent==="funnel"||l.intent==="update_funnel"){const u=await E(l.recommendedProducts||[],(o==null?void 0:o.use_feed_1)||!0,(o==null?void 0:o.use_feed_2)||!0),f={id:`bot-${Date.now()}`,role:"bot",text:l.botResponse,isFunnelMessage:!0,funnelProducts:u,symptomList:l.symptomList};r(h=>[...h,f])}else{const u="https://n8n.srv980546.hstgr.cloud/webhook/22856d03-acea-4174-89ae-1b6f0c8ede71/chat";try{const f={sessionId:i,action:"sendMessage",chatInput:c,chatHistory:x,intent:l.intent,detectedSymptoms:l.symptomList||[]};p("Calling N8N webhook:",{url:u,payload:f});const h=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)});if(!h.ok)throw new Error(`N8N webhook failed: ${h.status}`);const b=await h.json();p("N8N response:",b);const N={id:`bot-${Date.now()}`,role:"bot",text:b.output||b.text||"OmlouvÃ¡me se, nepodaÅ™ilo se zÃ­skat odpovÄ›Ä.",hasCallout:l.hasCallout};r(_=>[..._,N])}catch(f){j("N8N webhook error:",f);const h={id:`bot-${Date.now()}`,role:"bot",text:l.botResponse||"OmlouvÃ¡me se, doÅ¡lo k chybÄ› pÅ™i zpracovÃ¡nÃ­.",hasCallout:l.hasCallout};r(b=>[...b,h])}}}catch(x){j("Chyba pÅ™i zpracovÃ¡nÃ­ zprÃ¡vy:",x);const l={id:`bot-${Date.now()}`,role:"bot",text:"OmlouvÃ¡me se, doÅ¡lo k chybÄ›. Zkuste to prosÃ­m znovu."};r(u=>[...u,l])}finally{a(!1)}},[n,s,i,o,e]);return t.jsxs("div",{className:"flex flex-col h-screen bg-gray-50 font-sans",children:[t.jsx(P,{chatbotName:(o==null?void 0:o.chatbot_name)||"Wany.Chat"}),t.jsx(Q,{messages:n,isLoading:s,chatbotSettings:o,sessionId:i}),t.jsx("div",{className:"bg-white border-t border-gray-200 p-4",children:t.jsx(Y,{onSendMessage:w,isLoading:s})})]})},ee=()=>{const[e,o]=d.useState(null),[n,r]=d.useState(null),[s,a]=d.useState(!0),[i,y]=d.useState(null);d.useEffect(()=>{w()},[]);const w=async()=>{try{p("Inicializace widget containeru..."),G()||p("âš ï¸ Widget nenÃ­ v iframe - bÄ›Å¾Ã­ standalone");const c=F();o(c),p("Config naÄten:",c),V(c.theme);const g=await U(c.chatbotId);if(!g)throw new Error("NepodaÅ™ilo se naÄÃ­st nastavenÃ­ chatbota");r(g),p("Chatbot settings naÄteny:",g),a(!1)}catch(c){j("Chyba pÅ™i inicializaci widgetu:",c),y(c instanceof Error?c.message:"NeznÃ¡mÃ¡ chyba"),a(!1)}};return s?t.jsx("div",{className:"flex items-center justify-center h-screen bg-gray-50",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600",children:"NaÄÃ­tÃ¡m chat..."})]})}):i||!e||!n?t.jsx("div",{className:"flex items-center justify-center h-screen bg-gray-50",children:t.jsxs("div",{className:"text-center p-8",children:[t.jsx("div",{className:"text-red-500 text-4xl mb-4",children:"âš ï¸"}),t.jsx("h2",{className:"text-xl font-semibold text-gray-800 mb-2",children:"Chyba pÅ™i naÄÃ­tÃ¡nÃ­"}),t.jsx("p",{className:"text-gray-600",children:i||"NepodaÅ™ilo se naÄÃ­st konfiguraci"})]})}):t.jsx(X,{config:e,chatbotSettings:n})};console.log("ğŸš€ Widget Entry Point inicializovÃ¡n");const te=T.createRoot(document.getElementById("root"));te.render(t.jsx($.StrictMode,{children:t.jsx(ee,{})}));console.log("âœ… Widget React aplikace renderovÃ¡na");
