<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P≈ô√≠m√Ω Test Supabase pro Produkty</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-header {
            background: linear-gradient(135deg, #6f42c1 0%, #007bff 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .test-button {
            background: #6f42c1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.2s;
        }
        .test-button:hover {
            background: #5a2d91;
            transform: translateY(-1px);
        }
        .test-button.success {
            background: #28a745;
        }
        .test-button.error {
            background: #dc3545;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            min-height: 100px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }
        .results.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .results.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .results.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .product-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .product-name {
            font-weight: bold;
            font-size: 16px;
            color: #333;
            margin-bottom: 8px;
        }
        .product-price {
            font-size: 18px;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 8px;
        }
        .product-url {
            color: #007bff;
            text-decoration: none;
            font-size: 12px;
        }
        .product-url:hover {
            text-decoration: underline;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
    </style>
</head>
<body>
    <div class="test-header">
        <h1>üß™ P≈ô√≠m√Ω Test Supabase Produkt≈Ø</h1>
        <p>Testuje p≈ôesnƒõ to sam√©, co dƒõl√° hybridn√≠ syst√©m</p>
    </div>

    <div class="test-container">
        <div class="test-section">
            <h2>üéØ Test Hybridn√≠ch ID</h2>
            <p>Testuje ID produkt≈Ø z webhook testu: <code>1002318245, 1002737245, 1002324245</code></p>
            
            <button id="testHybridIds" class="test-button">Test Hybridn√≠ch ID</button>
            <div id="hybridResults" class="results info">Kliknƒõte na tlaƒç√≠tko pro test hybridn√≠ch ID...</div>
        </div>

        <div class="test-section">
            <h2>üîß Inicializace Tabulky</h2>
            <p>Vytvo≈ô√≠ tabulku a vlo≈æ√≠ testovac√≠ data, pokud neexistuj√≠.</p>
            
            <button id="initializeTable" class="test-button">Inicializovat Tabulku</button>
            <div id="initResults" class="results info">Kliknƒõte na tlaƒç√≠tko pro inicializaci...</div>
        </div>

        <div class="test-section">
            <h2>üìä Kompletn√≠ Diagnostika</h2>
            <p>Spust√≠ kompletn√≠ diagnostiku v≈°ech aspekt≈Ø produktov√© tabulky.</p>
            
            <button id="runDiagnostics" class="test-button">Spustit Diagnostiku</button>
            <div id="diagnosticsResults" class="results info">Kliknƒõte na tlaƒç√≠tko pro diagnostiku...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase konfigurace
        const SUPABASE_URL = 'https://umxkjdllhlkclrplxdxx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVteGtqZGxsaGxrY2xycGx4ZHh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjEyMzM0MTMsImV4cCI6MjAzNjgwOTQxM30.MKSjLqO1YMGwGOdZIttWOwrCaQTSHkf6Fc-9XQbQ8t0';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Test hybridn√≠ch ID (p≈ôesnƒõ to sam√© jako v k√≥du)
        document.getElementById('testHybridIds').addEventListener('click', async () => {
            const resultDiv = document.getElementById('hybridResults');
            resultDiv.className = 'results info';
            resultDiv.innerHTML = 'üîÑ Testuji hybridn√≠ ID...';
            
            try {
                const testIds = ['1002318245', '1002737245', '1002324245'];
                console.log('üîç Hled√°m produkty s ID:', testIds);
                
                // P≈òESNƒö STEJN√ù DOTAZ JAKO V HYBRID SERVICE
                const { data, error } = await supabase
                    .from('products')
                    .select('*')
                    .in('product_code', testIds);
                
                if (error) {
                    throw error;
                }
                
                let result = `‚úÖ SUPABASE DOTAZ √öSPƒö≈†N√ù!\n\n`;
                result += `Hledan√° ID: ${testIds.join(', ')}\n`;
                result += `Nalezeno produkt≈Ø: ${data?.length || 0}\n\n`;
                
                if (data && data.length > 0) {
                    result += `DETAILY NALEZEN√ùCH PRODUKT≈Æ:\n`;
                    result += `${'='.repeat(50)}\n`;
                    
                    data.forEach((product, index) => {
                        result += `\n${index + 1}. PRODUKT:\n`;
                        result += `   Product Code: ${product.product_code}\n`;
                        result += `   N√°zev: ${product.name || 'CHYB√ç'}\n`;
                        result += `   Cena: ${product.price || 'CHYB√ç'} ${product.currency || 'N/A'}\n`;
                        result += `   URL: ${product.product_url ? 'M√° URL' : 'CHYB√ç URL'}\n`;
                        result += `   Obr√°zek: ${product.image_url ? 'M√° obr√°zek' : 'CHYB√ç OBR√ÅZEK'}\n`;
                        result += `   Kategorie: ${product.category || 'CHYB√ç'}\n`;
                        
                        // Anal√Ωza kompletnosti
                        const completeness = [
                            product.name,
                            product.price,
                            product.product_url,
                            product.image_url,
                            product.category
                        ].filter(Boolean).length;
                        
                        result += `   Kompletnost: ${completeness}/5 `;
                        if (completeness === 5) result += 'üü¢ Perfektn√≠';
                        else if (completeness >= 3) result += 'üü° Dobr√°';
                        else result += 'üî¥ Nedostaƒçuj√≠c√≠';
                        result += `\n`;
                    });
                } else {
                    result += `‚ùå ≈Ω√ÅDN√â PRODUKTY NENALEZENY!\n\n`;
                    result += `Mo≈æn√© p≈ô√≠ƒçiny:\n`;
                    result += `1. Tabulka products neexistuje\n`;
                    result += `2. Tabulka je pr√°zdn√°\n`;
                    result += `3. ID produkt≈Ø neexistuj√≠ v datab√°zi\n\n`;
                    result += `≈òe≈°en√≠: Kliknƒõte na "Inicializovat Tabulku"`;
                }
                
                resultDiv.className = data && data.length > 0 ? 'results success' : 'results error';
                resultDiv.textContent = result;
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi testu hybridn√≠ch ID:', error);
                
                let errorMsg = `‚ùå CHYBA PRI TESTU HYBRIDN√çCH ID!\n\n`;
                errorMsg += `Error: ${error.message}\n`;
                errorMsg += `Code: ${error.code}\n\n`;
                
                if (error.code === 'PGRST116') {
                    errorMsg += `DIAGN√ìZA: Tabulka "products" neexistuje!\n\n`;
                    errorMsg += `≈òE≈†EN√ç:\n`;
                    errorMsg += `1. Kliknƒõte na "Inicializovat Tabulku"\n`;
                    errorMsg += `2. Nebo spus≈•te verify_and_populate_products_table.sql v Supabase SQL editoru\n`;
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg += `DIAGN√ìZA: S√≠≈•ov√° chyba nebo CORS probl√©m!\n\n`;
                    errorMsg += `≈òE≈†EN√ç:\n`;
                    errorMsg += `1. Zkontrolujte internetov√© p≈ôipojen√≠\n`;
                    errorMsg += `2. Ovƒõ≈ôte Supabase URL a kl√≠ƒçe\n`;
                    errorMsg += `3. Zkuste obnovit str√°nku\n`;
                }
                
                resultDiv.className = 'results error';
                resultDiv.textContent = errorMsg;
            }
        });

        // Inicializace tabulky
        document.getElementById('initializeTable').addEventListener('click', async () => {
            const resultDiv = document.getElementById('initResults');
            resultDiv.className = 'results info';
            resultDiv.innerHTML = 'üîÑ Inicializuji tabulku...';
            
            try {
                // Pokus o vlo≈æen√≠ testovac√≠ch dat
                const testProducts = [
                    {
                        product_code: '1002318245',
                        name: 'BEWIT Yin Qiao Jie Du Wan - Bylinn√° smƒõs proti toxick√©mu horku',
                        description: 'Tradiƒçn√≠ ƒç√≠nsk√° bylinn√° smƒõs napom√°h√° p≈ôi prvn√≠ch projevech napaden√≠ toxick√Ωm horkem a vƒõtrem.',
                        category: 'Tradiƒçn√≠ ƒç√≠nsk√° medic√≠na',
                        price: 1299.00,
                        currency: 'CZK',
                        product_url: 'https://bewit.love/produkt/bewit-vetrolam?variant=6727',
                        image_url: 'https://bewit.love/storage/products/yin-qiao-jie-du-wan.jpg'
                    },
                    {
                        product_code: '1002737245',
                        name: 'BEWIT Chuan Xiong Cha Tiao Wan - Eliminace vƒõtru',
                        description: 'Produkt navr≈æen pro zkrocen√≠ chladu a vƒõtru pod k≈Ø≈æ√≠.',
                        category: 'Tradiƒçn√≠ ƒç√≠nsk√° medic√≠na',
                        price: 1499.00,
                        currency: 'CZK',
                        product_url: 'https://bewit.love/produkt/bewit-eliminace-vetru?variant=7666',
                        image_url: 'https://bewit.love/storage/products/chuan-xiong-cha-tiao-wan.jpg'
                    },
                    {
                        product_code: '1002324245',
                        name: 'BEWIT Xiao Qing Long Wan - Ochrana proti chladn√Ωm vƒõtr≈Øm',
                        description: 'L√©k p≈Øsob√≠ jako ochrann√Ω faktor proti chladn√Ωm vƒõtr≈Øm.',
                        category: 'Tradiƒçn√≠ ƒç√≠nsk√° medic√≠na',
                        price: 1199.00,
                        currency: 'CZK',
                        product_url: 'https://bewit.love/produkt/bewit-ochrana-vetru',
                        image_url: 'https://bewit.love/storage/products/xiao-qing-long-wan.jpg'
                    }
                ];

                // Pokus o upsert (update nebo insert)
                const { data, error } = await supabase
                    .from('products')
                    .upsert(testProducts, { onConflict: 'product_code' })
                    .select();

                if (error) {
                    throw error;
                }

                let result = `‚úÖ TABULKA √öSPƒö≈†Nƒö INICIALIZOV√ÅNA!\n\n`;
                result += `Vlo≈æeno/aktualizov√°no produkt≈Ø: ${data?.length || testProducts.length}\n\n`;
                result += `VLO≈ΩEN√â PRODUKTY:\n`;
                
                testProducts.forEach((product, index) => {
                    result += `${index + 1}. ${product.name}\n`;
                    result += `   Code: ${product.product_code}\n`;
                    result += `   Cena: ${product.price} ${product.currency}\n\n`;
                });

                resultDiv.className = 'results success';
                resultDiv.textContent = result;

            } catch (error) {
                console.error('‚ùå Chyba p≈ôi inicializaci tabulky:', error);
                
                let errorMsg = `‚ùå CHYBA PRI INICIALIZACI!\n\n`;
                errorMsg += `Error: ${error.message}\n`;
                errorMsg += `Code: ${error.code}\n\n`;
                
                if (error.code === 'PGRST116') {
                    errorMsg += `DIAGN√ìZA: Tabulka "products" neexistuje a nelze ji vytvo≈ôit p≈ôes JavaScript!\n\n`;
                    errorMsg += `≈òE≈†EN√ç:\n`;
                    errorMsg += `1. P≈ôejdƒõte do Supabase Dashboard ‚Üí SQL Editor\n`;
                    errorMsg += `2. Spus≈•te obsah souboru: verify_and_populate_products_table.sql\n`;
                    errorMsg += `3. Nebo vytvo≈ôte tabulku manu√°lnƒõ podle create_products_table.sql\n`;
                } else if (error.code === '42501') {
                    errorMsg += `DIAGN√ìZA: Nedostateƒçn√° opr√°vnƒõn√≠ pro z√°pis!\n\n`;
                    errorMsg += `≈òE≈†EN√ç:\n`;
                    errorMsg += `1. Zkontrolujte RLS (Row Level Security) nastaven√≠\n`;
                    errorMsg += `2. Ovƒõ≈ôte insert policy pro tabulku products\n`;
                }
                
                resultDiv.className = 'results error';
                resultDiv.textContent = errorMsg;
            }
        });

        // Kompletn√≠ diagnostika
        document.getElementById('runDiagnostics').addEventListener('click', async () => {
            const resultDiv = document.getElementById('diagnosticsResults');
            resultDiv.className = 'results info';
            resultDiv.innerHTML = 'üîÑ Spou≈°t√≠m kompletn√≠ diagnostiku...';
            
            let diagnostics = `üîç KOMPLETN√ç DIAGNOSTIKA SUPABASE PRODUKT≈Æ\n`;
            diagnostics += `${'='.repeat(60)}\n\n`;
            diagnostics += `üïê ƒåas: ${new Date().toLocaleString()}\n`;
            diagnostics += `üåê URL: ${SUPABASE_URL}\n\n`;

            try {
                // Test 1: Z√°kladn√≠ p≈ôipojen√≠
                diagnostics += `üì° TEST 1: Z√°kladn√≠ p≈ôipojen√≠...\n`;
                const { data: session } = await supabase.auth.getSession();
                diagnostics += `‚úÖ Supabase klient funguje\n`;
                diagnostics += `üîê Auth session: ${session?.session ? 'Ano' : 'Ne'}\n\n`;

                // Test 2: Existence tabulky
                diagnostics += `üìã TEST 2: Existence tabulky products...\n`;
                const { data: tableTest, error: tableError } = await supabase
                    .from('products')
                    .select('count')
                    .limit(1);

                if (tableError) {
                    if (tableError.code === 'PGRST116') {
                        diagnostics += `‚ùå Tabulka "products" NEEXISTUJE!\n\n`;
                    } else {
                        diagnostics += `‚ùå Chyba p≈ôi p≈ô√≠stupu k tabulce: ${tableError.message}\n\n`;
                    }
                } else {
                    diagnostics += `‚úÖ Tabulka "products" existuje\n\n`;

                    // Test 3: Poƒçet z√°znam≈Ø
                    diagnostics += `üìä TEST 3: Poƒçet z√°znam≈Ø...\n`;
                    const { count, error: countError } = await supabase
                        .from('products')
                        .select('*', { count: 'exact', head: true });

                    if (countError) {
                        diagnostics += `‚ùå Chyba p≈ôi poƒç√≠t√°n√≠: ${countError.message}\n\n`;
                    } else {
                        diagnostics += `üìà Celkem z√°znam≈Ø: ${count}\n\n`;

                        if (count > 0) {
                            // Test 4: Hybridn√≠ ID
                            diagnostics += `üéØ TEST 4: Hybridn√≠ ID produkty...\n`;
                            const testIds = ['1002318245', '1002737245', '1002324245'];
                            const { data: hybridProducts, error: hybridError } = await supabase
                                .from('products')
                                .select('product_code, name, price, currency, product_url, image_url')
                                .in('product_code', testIds);

                            if (hybridError) {
                                diagnostics += `‚ùå Chyba p≈ôi hled√°n√≠ hybridn√≠ch ID: ${hybridError.message}\n\n`;
                            } else {
                                diagnostics += `üîç Nalezeno ${hybridProducts.length}/${testIds.length} hybridn√≠ch produkt≈Ø\n`;
                                
                                hybridProducts.forEach(product => {
                                    diagnostics += `   ‚úÖ ${product.product_code}: ${product.name}\n`;
                                    diagnostics += `      üí∞ ${product.price} ${product.currency}\n`;
                                    diagnostics += `      üîó ${product.product_url ? 'M√° URL' : 'Chyb√≠ URL'}\n`;
                                    diagnostics += `      üñºÔ∏è ${product.image_url ? 'M√° obr√°zek' : 'Chyb√≠ obr√°zek'}\n`;
                                });
                                diagnostics += `\n`;
                            }

                            // Test 5: Uk√°zka v≈°ech produkt≈Ø
                            diagnostics += `üìã TEST 5: Prvn√≠ch 5 produkt≈Ø...\n`;
                            const { data: sampleProducts, error: sampleError } = await supabase
                                .from('products')
                                .select('product_code, name, price, currency')
                                .limit(5);

                            if (sampleError) {
                                diagnostics += `‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ uk√°zky: ${sampleError.message}\n\n`;
                            } else {
                                sampleProducts.forEach((product, index) => {
                                    diagnostics += `   ${index + 1}. ${product.product_code}: ${product.name} (${product.price} ${product.currency})\n`;
                                });
                                diagnostics += `\n`;
                            }
                        } else {
                            diagnostics += `‚ö†Ô∏è Tabulka je pr√°zdn√° - ≈æ√°dn√© produkty k testov√°n√≠\n\n`;
                        }
                    }
                }

                // Z√°vƒõreƒçn√© hodnocen√≠
                diagnostics += `üéØ Z√ÅVƒöREƒåN√â HODNOCEN√ç:\n`;
                if (tableError?.code === 'PGRST116') {
                    diagnostics += `üî¥ KRITICK√ù PROBL√âM: Tabulka products neexistuje\n`;
                    diagnostics += `üìã ≈òE≈†EN√ç: Spus≈•te verify_and_populate_products_table.sql\n`;
                } else if (count === 0) {
                    diagnostics += `üü° ƒå√ÅSTEƒåN√ù PROBL√âM: Tabulka existuje, ale je pr√°zdn√°\n`;
                    diagnostics += `üìã ≈òE≈†EN√ç: Kliknƒõte na "Inicializovat Tabulku"\n`;
                } else {
                    diagnostics += `üü¢ V≈†E V PO≈ò√ÅDKU: Tabulka existuje a obsahuje data\n`;
                    diagnostics += `üí° Pokud probl√©my p≈ôetrv√°vaj√≠, zkontrolujte aplikaƒçn√≠ logiku\n`;
                }

                resultDiv.className = 'results success';
                resultDiv.textContent = diagnostics;

            } catch (error) {
                diagnostics += `\n‚ùå KRITICK√Å CHYBA DIAGNOSTIKY!\n`;
                diagnostics += `Error: ${error.message}\n`;
                diagnostics += `Stack: ${error.stack}\n`;

                resultDiv.className = 'results error';
                resultDiv.textContent = diagnostics;
            }
        });

        // Automaticky spustit test hybridn√≠ch ID p≈ôi naƒçten√≠
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                document.getElementById('testHybridIds').click();
            }, 1000);
        });
    </script>
</body>
</html>
