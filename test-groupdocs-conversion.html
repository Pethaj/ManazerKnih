<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test GroupDocs Conversion API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-section {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .info {
            color: #007bff;
            font-weight: bold;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .file-input {
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .supported-formats {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .supported-formats ul {
            margin: 0;
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <h1>üîÑ Test GroupDocs Conversion API</h1>
    <p>Testov√°n√≠ konverze EPUB, MOBI a dal≈°√≠ch form√°t≈Ø do PDF pomoc√≠ GroupDocs.Conversion Cloud API</p>

    <div class="container">
        <h2>üìã Informace o API</h2>
        <div class="test-section">
            <h3>Konfiguraƒçn√≠ √∫daje</h3>
            <p><strong>Client ID:</strong> 022eaad9-af7c-446a-b94e-a3a75f6cc35e</p>
            <p><strong>API Base URL:</strong> https://api.groupdocs.cloud/v2.0</p>
            <p><strong>Token URL:</strong> https://api.groupdocs.cloud/connect/token</p>
        </div>

        <div class="supported-formats">
            <h3>üìö Podporovan√© form√°ty pro konverzi do PDF</h3>
            <ul>
                <li><strong>EPUB</strong> - EPUB e-kniha</li>
                <li><strong>MOBI</strong> - MOBI e-kniha (Kindle)</li>
                <li><strong>DOCX</strong> - Microsoft Word dokument</li>
                <li><strong>DOC</strong> - Microsoft Word dokument (star≈°√≠)</li>
                <li><strong>TXT</strong> - Textov√Ω soubor</li>
                <li><strong>RTF</strong> - Rich Text Format</li>
                <li><strong>HTML</strong> - HTML dokument</li>
            </ul>
        </div>
    </div>

    <div class="container">
        <h2>üîë Test autentifikace</h2>
        <div class="test-section">
            <button onclick="testAuthentication()">Z√≠skat Access Token</button>
            <div id="authResult" class="log"></div>
        </div>
    </div>

    <div class="container">
        <h2>üìÅ Test konverze souboru</h2>
        <div class="test-section">
            <input type="file" id="fileInput" class="file-input" accept=".epub,.mobi,.docx,.doc,.txt,.rtf,.html">
            <br>
            <button onclick="testConversion()" id="convertBtn">Konvertovat do PDF</button>
            <button onclick="clearLog()">Vymazat log</button>
            <div id="conversionResult" class="log"></div>
        </div>
    </div>

    <div class="container">
        <h2>üìù Testovac√≠ soubory</h2>
        <div class="test-section">
            <p>Pro testov√°n√≠ m≈Ø≈æete pou≈æ√≠t:</p>
            <ul>
                <li><button onclick="createTestEpub()">Vytvo≈ôit testovac√≠ EPUB soubor</button></li>
                <li><button onclick="createTestTxt()">Vytvo≈ôit testovac√≠ TXT soubor</button></li>
                <li><button onclick="createTestHtml()">Vytvo≈ôit testovac√≠ HTML soubor</button></li>
            </ul>
        </div>
    </div>

    <script>
        // Import GroupDocs Conversion Service
        class GroupDocsConversionService {
            static API_BASE_URL = 'https://api.groupdocs.cloud/v2.0';
            static CREDENTIALS = {
                clientId: '022eaad9-af7c-446a-b94e-a3a75f6cc35e',
                clientSecret: '7cd5e2e58337595bffff974a29c0ecc6'
            };

            static accessToken = null;
            static tokenExpiry = 0;

            static async getAccessToken() {
                if (this.accessToken && Date.now() < this.tokenExpiry) {
                    console.log('üîë Pou≈æ√≠v√°m existuj√≠c√≠ GroupDocs access token');
                    return this.accessToken;
                }

                console.log('üîÑ Z√≠sk√°v√°m nov√Ω GroupDocs access token...');

                try {
                    const response = await fetch('https://api.groupdocs.cloud/connect/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            grant_type: 'client_credentials',
                            client_id: this.CREDENTIALS.clientId,
                            client_secret: this.CREDENTIALS.clientSecret
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Nelze z√≠skat access token: ${response.status} - ${errorText}`);
                    }

                    const tokenData = await response.json();
                    
                    if (!tokenData.access_token) {
                        throw new Error('API nevr√°tilo access token');
                    }

                    this.accessToken = tokenData.access_token;
                    this.tokenExpiry = Date.now() + ((tokenData.expires_in || 86400) - 3600) * 1000;

                    console.log('‚úÖ GroupDocs access token √∫spƒõ≈°nƒõ z√≠sk√°n');
                    return this.accessToken;

                } catch (error) {
                    console.error('‚ùå Chyba p≈ôi z√≠sk√°v√°n√≠ GroupDocs access token:', error);
                    throw new Error(`Nelze se autentizovat do GroupDocs API: ${error.message}`);
                }
            }

            static async uploadFile(file, fileName) {
                const token = await this.getAccessToken();
                
                console.log(`üì§ Nahr√°v√°m soubor "${fileName}" do GroupDocs Storage...`);

                try {
                    const response = await fetch(`${this.API_BASE_URL}/storage/file/${encodeURIComponent(fileName)}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': file.type || 'application/octet-stream'
                        },
                        body: file
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Upload selhal: ${response.status} - ${errorText}`);
                    }

                    console.log(`‚úÖ Soubor "${fileName}" √∫spƒõ≈°nƒõ nahr√°n do GroupDocs Storage`);
                    return fileName;

                } catch (error) {
                    console.error('‚ùå Chyba p≈ôi uploadu souboru:', error);
                    throw new Error(`Nelze nahr√°t soubor: ${error.message}`);
                }
            }

            static async convertFile(inputFileName, outputFormat = 'pdf') {
                const token = await this.getAccessToken();
                const outputFileName = inputFileName.replace(/\.[^/.]+$/, `.${outputFormat}`);

                console.log(`üîÑ Spou≈°t√≠m konverzi "${inputFileName}" ‚Üí "${outputFileName}"...`);

                try {
                    const conversionRequest = {
                        FilePath: inputFileName,
                        Format: outputFormat,
                        OutputPath: 'converted'
                    };

                    const response = await fetch(`${this.API_BASE_URL}/conversion`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(conversionRequest)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Konverze selhala: ${response.status} - ${errorText}`);
                    }

                    const result = await response.json();
                    
                    if (!result || !result.length || !result[0].path) {
                        throw new Error('API nevr√°tilo platnou cestu k konvertovan√©mu souboru');
                    }

                    const convertedFilePath = result[0].path;
                    console.log(`‚úÖ Konverze dokonƒçena, v√Ωstupn√≠ soubor: "${convertedFilePath}"`);
                    
                    return convertedFilePath;

                } catch (error) {
                    console.error('‚ùå Chyba p≈ôi konverzi souboru:', error);
                    throw new Error(`Konverze selhala: ${error.message}`);
                }
            }

            static async downloadFile(filePath) {
                const token = await this.getAccessToken();

                console.log(`üì• Stahuji konvertovan√Ω soubor "${filePath}"...`);

                try {
                    const response = await fetch(`${this.API_BASE_URL}/storage/file/${encodeURIComponent(filePath)}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Download selhal: ${response.status} - ${errorText}`);
                    }

                    const fileBlob = await response.blob();
                    console.log(`‚úÖ Soubor "${filePath}" √∫spƒõ≈°nƒõ sta≈æen (${fileBlob.size} bytes)`);
                    
                    return fileBlob;

                } catch (error) {
                    console.error('‚ùå Chyba p≈ôi stahov√°n√≠ souboru:', error);
                    throw new Error(`Nelze st√°hnout soubor: ${error.message}`);
                }
            }

            static async deleteFile(filePath) {
                const token = await this.getAccessToken();

                try {
                    await fetch(`${this.API_BASE_URL}/storage/file/${encodeURIComponent(filePath)}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    console.log(`üóëÔ∏è Soubor "${filePath}" vymaz√°n z GroupDocs Storage`);
                } catch (error) {
                    console.warn('‚ö†Ô∏è Nelze vymazat doƒçasn√Ω soubor z GroupDocs Storage:', error);
                }
            }

            static async convertToPDF(file) {
                console.log('üöÄ GroupDocs Conversion: Spou≈°t√≠m konverzi do PDF...');
                console.log(`üìÑ Zdrojov√Ω soubor: ${file.name} (${file.type}, ${file.size} bytes)`);

                const supportedFormats = ['epub', 'mobi', 'docx', 'doc', 'txt', 'rtf', 'html'];
                const fileExtension = file.name.split('.').pop()?.toLowerCase() || '';
                
                if (!supportedFormats.includes(fileExtension)) {
                    return {
                        success: false,
                        error: `Nepodporovan√Ω form√°t souboru: ${fileExtension}. Podporovan√© form√°ty: ${supportedFormats.join(', ')}`
                    };
                }

                const tempFileName = `temp_${Date.now()}_${file.name}`;
                let uploadedFilePath = null;
                let convertedFilePath = null;

                try {
                    uploadedFilePath = await this.uploadFile(file, tempFileName);
                    convertedFilePath = await this.convertFile(uploadedFilePath, 'pdf');
                    const pdfBlob = await this.downloadFile(convertedFilePath);

                    if (uploadedFilePath) {
                        await this.deleteFile(uploadedFilePath);
                    }
                    if (convertedFilePath) {
                        await this.deleteFile(convertedFilePath);
                    }

                    console.log('‚úÖ GroupDocs Conversion: Konverze do PDF √∫spƒõ≈°nƒõ dokonƒçena');

                    return {
                        success: true,
                        data: pdfBlob
                    };

                } catch (error) {
                    console.error('‚ùå GroupDocs Conversion chyba:', error);

                    try {
                        if (uploadedFilePath) {
                            await this.deleteFile(uploadedFilePath);
                        }
                        if (convertedFilePath) {
                            await this.deleteFile(convertedFilePath);
                        }
                    } catch (cleanupError) {
                        console.warn('‚ö†Ô∏è Chyba p≈ôi cleanup:', cleanupError);
                    }

                    return {
                        success: false,
                        error: error.message
                    };
                }
            }
        }

        // Test funkce
        function logMessage(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            element.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            element.scrollTop = element.scrollHeight;
        }

        function clearLog() {
            document.getElementById('conversionResult').innerHTML = '';
        }

        async function testAuthentication() {
            const resultDiv = document.getElementById('authResult');
            resultDiv.innerHTML = '';
            
            try {
                logMessage('authResult', 'üîÑ Testov√°n√≠ autentifikace...', 'info');
                const token = await GroupDocsConversionService.getAccessToken();
                logMessage('authResult', `‚úÖ √öspƒõ≈°nƒõ z√≠sk√°n access token: ${token.substring(0, 50)}...`, 'success');
                logMessage('authResult', `üìÖ Token expiry: ${new Date(GroupDocsConversionService.tokenExpiry).toLocaleString()}`, 'info');
            } catch (error) {
                logMessage('authResult', `‚ùå Chyba autentifikace: ${error.message}`, 'error');
            }
        }

        async function testConversion() {
            const fileInput = document.getElementById('fileInput');
            const convertBtn = document.getElementById('convertBtn');
            
            if (!fileInput.files[0]) {
                logMessage('conversionResult', '‚ùå Pros√≠m vyberte soubor pro konverzi', 'error');
                return;
            }

            const file = fileInput.files[0];
            convertBtn.disabled = true;
            
            try {
                logMessage('conversionResult', `üîÑ Spou≈°t√≠m konverzi souboru: ${file.name}`, 'info');
                logMessage('conversionResult', `üìä Velikost souboru: ${(file.size / 1024).toFixed(2)} KB`, 'info');
                
                const result = await GroupDocsConversionService.convertToPDF(file);
                
                if (result.success) {
                    logMessage('conversionResult', `‚úÖ Konverze √∫spƒõ≈°n√°! PDF velikost: ${(result.data.size / 1024).toFixed(2)} KB`, 'success');
                    
                    // St√°hnout konvertovan√Ω PDF
                    const url = URL.createObjectURL(result.data);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.name.replace(/\.[^/.]+$/, '.pdf');
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    logMessage('conversionResult', 'üíæ PDF soubor sta≈æen automaticky', 'success');
                } else {
                    logMessage('conversionResult', `‚ùå Konverze selhala: ${result.error}`, 'error');
                }
            } catch (error) {
                logMessage('conversionResult', `‚ùå Neoƒçek√°van√° chyba: ${error.message}`, 'error');
            } finally {
                convertBtn.disabled = false;
            }
        }

        // Funkce pro vytvo≈ôen√≠ testovac√≠ch soubor≈Ø
        function createTestEpub() {
            // Vytvo≈ô√≠me minim√°ln√≠ EPUB strukturu
            const epubContent = `
                Toto je testovac√≠ EPUB soubor pro konverzi do PDF.
                
                Obsahuje z√°kladn√≠ text kter√Ω bude konvertov√°n pomoc√≠ GroupDocs Conversion API.
                
                Test obsahu:
                - Seznam polo≈æek
                - Dal≈°√≠ polo≈æka
                - Posledn√≠ polo≈æka
                
                Konec testovac√≠ho obsahu.
            `;
            
            const blob = new Blob([epubContent], { type: 'application/epub+zip' });
            downloadBlob(blob, 'test-document.epub');
        }

        function createTestTxt() {
            const txtContent = `Test dokument pro konverzi do PDF

Toto je testovac√≠ textov√Ω soubor kter√Ω bude konvertov√°n pomoc√≠ GroupDocs Conversion API.

Obsah:
1. Prvn√≠ odstavec s nƒõjak√Ωm textem
2. Druh√Ω odstavec s dal≈°√≠m obsahem
3. T≈ôet√≠ odstavec pro √∫plnost

Datum vytvo≈ôen√≠: ${new Date().toLocaleString()}
            `;
            
            const blob = new Blob([txtContent], { type: 'text/plain' });
            downloadBlob(blob, 'test-document.txt');
        }

        function createTestHtml() {
            const htmlContent = `<!DOCTYPE html>
<html>
<head>
    <title>Test HTML dokument</title>
    <meta charset="utf-8">
</head>
<body>
    <h1>Test HTML dokumentu pro konverzi</h1>
    <p>Toto je testovac√≠ HTML soubor pro konverzi do PDF pomoc√≠ GroupDocs Conversion API.</p>
    
    <h2>Seznam testovac√≠ch prvk≈Ø</h2>
    <ul>
        <li>Prvn√≠ polo≈æka seznamu</li>
        <li>Druh√° polo≈æka seznamu</li>
        <li>T≈ôet√≠ polo≈æka seznamu</li>
    </ul>
    
    <h2>Tabulka</h2>
    <table border="1">
        <tr>
            <th>Sloupec 1</th>
            <th>Sloupec 2</th>
        </tr>
        <tr>
            <td>Data 1</td>
            <td>Data 2</td>
        </tr>
    </table>
    
    <p><strong>Datum vytvo≈ôen√≠:</strong> ${new Date().toLocaleString()}</p>
</body>
</html>`;
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            downloadBlob(blob, 'test-document.html');
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            logMessage('conversionResult', `üìÅ Vytvo≈ôen testovac√≠ soubor: ${filename}`, 'success');
        }

        // Automatic test na naƒçten√≠ str√°nky
        window.addEventListener('load', function() {
            logMessage('conversionResult', 'üöÄ Str√°nka naƒçtena. M≈Ø≈æete zaƒç√≠t testovat konverzi.', 'info');
            logMessage('conversionResult', 'üí° Tip: Nejd≈ô√≠ve otestujte autentifikaci pomoc√≠ tlaƒç√≠tka "Z√≠skat Access Token"', 'info');
        });
    </script>
</body>
</html>
