<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostika produktov√© synchronizace</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 10px; 
            border-radius: 4px; 
            margin: 10px 0; 
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        
        pre { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 4px; 
            overflow-x: auto; 
            white-space: pre-wrap;
            border: 1px solid #dee2e6;
        }
        
        .log-entry {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        .log-entry:last-child { border-bottom: none; }
        
        .timestamp { 
            font-weight: bold; 
            color: #0056b3; 
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>üîç Diagnostika produktov√© synchronizace BEWIT</h1>
    
    <div class="container">
        <h2>üìä Aktu√°ln√≠ stav synchronizace</h2>
        <div id="currentStatus" class="status info">Naƒç√≠t√°m stav synchronizace...</div>
        
        <div class="stats" id="statsContainer">
            <!-- Statistiky se vygeneruj√≠ dynamicky -->
        </div>
        
        <button onclick="checkSyncStatus()">üîÑ Aktualizovat stav</button>
        <button onclick="testManualSync()">üß™ Test manu√°ln√≠ synchronizace</button>
        <button onclick="checkEdgeFunction()">‚ö° Test Edge Function</button>
        <button onclick="checkCronJobs()">‚è∞ Kontrola Cron Jobs</button>
    </div>
    
    <div class="container">
        <h2>üìã Posledn√≠ch 10 synchronizac√≠</h2>
        <div id="syncLogs">Naƒç√≠t√°m logy...</div>
        <button onclick="loadSyncLogs()">üîÑ Obnovit logy</button>
    </div>
    
    <div class="container">
        <h2>üõ†Ô∏è Manu√°ln√≠ akce</h2>
        <button onclick="forceSyncNow()" id="forceSyncBtn">üöÄ Vynutit okam≈æitou synchronizaci</button>
        <button onclick="clearOldLogs()">üóëÔ∏è Vymazat star√© logy (>30 dn√≠)</button>
        <div id="manualActions"></div>
    </div>
    
    <div class="container">
        <h2>üìà Diagnostick√© informace</h2>
        <pre id="diagnostics">ƒåek√°m na naƒçten√≠ diagnostiky...</pre>
    </div>

    <script>
        // Supabase konfigurace
        const SUPABASE_URL = 'https://modopafybeslbcqjxsve.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vZG9wYWZ5YmVzbGJjcWp4c3ZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNTM0MjEsImV4cCI6MjA3MDgyOTQyMX0.8gxL0b9flTUyoltiEIJx8Djuiyx16rySlffHkd_nm1U';
        
        // Importujeme Supabase client
        let supabase;
        
        // Inicializace p≈ôi naƒçten√≠ str√°nky
        window.addEventListener('load', async () => {
            try {
                // Dynamick√Ω import Supabase
                const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                console.log('‚úÖ Supabase klient inicializov√°n');
                
                // Automaticky naƒçteme z√°kladn√≠ data
                await checkSyncStatus();
                await loadSyncLogs();
                await runDiagnostics();
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi inicializaci:', error);
                document.getElementById('currentStatus').innerHTML = `
                    <div class="status error">‚ùå Chyba p≈ôi inicializaci: ${error.message}</div>
                `;
            }
        });

        function formatDate(dateString) {
            if (!dateString) return 'Nezn√°m√Ω';
            const date = new Date(dateString);
            return date.toLocaleString('cs-CZ');
        }

        function formatTimeAgo(dateString) {
            if (!dateString) return 'Nezn√°m√Ω';
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffHours < 1) return 'P≈ôed chv√≠l√≠';
            if (diffHours < 24) return `P≈ôed ${diffHours} hodinami`;
            return `P≈ôed ${diffDays} dny`;
        }

        async function checkSyncStatus() {
            try {
                console.log('üîç Kontrolujem stav synchronizace...');
                
                // Naƒçteme posledn√≠ synchronizaci
                const { data: lastSync, error: syncError } = await supabase
                    .from('sync_logs')
                    .select('*')
                    .like('sync_type', '%products%')
                    .order('started_at', { ascending: false })
                    .limit(1)
                    .single();

                if (syncError && syncError.code !== 'PGRST116') {
                    throw syncError;
                }

                // Naƒçteme poƒçet produkt≈Ø
                const { count: productCount, error: countError } = await supabase
                    .from('products')
                    .select('*', { count: 'exact', head: true });

                if (countError) {
                    throw countError;
                }

                // Kontrola dne≈°n√≠ch synchronizac√≠
                const today = new Date().toISOString().split('T')[0];
                const { data: todaySync, error: todaySyncError } = await supabase
                    .from('sync_logs')
                    .select('*')
                    .like('sync_type', '%products%')
                    .gte('started_at', today + 'T00:00:00.000Z')
                    .order('started_at', { ascending: false });

                // Zobraz√≠me stav
                let statusHtml = '';
                let statusClass = 'info';

                if (lastSync) {
                    const lastSyncTime = formatTimeAgo(lastSync.started_at);
                    const isToday = todaySync && todaySync.length > 0;
                    
                    if (lastSync.status === 'success') {
                        statusClass = isToday ? 'success' : 'warning';
                        statusHtml = `
                            <div class="status ${statusClass}">
                                ${isToday ? '‚úÖ' : '‚ö†Ô∏è'} Posledn√≠ synchronizace: ${formatDate(lastSync.started_at)} (${lastSyncTime})<br>
                                üìä Zpracov√°no: ${lastSync.records_processed || 0}, Nov√Ωch: ${lastSync.records_inserted || 0}, Aktualizov√°no: ${lastSync.records_updated || 0}<br>
                                ${!isToday ? '<strong>‚ö†Ô∏è Dnes je≈°tƒõ neprobƒõhla ≈æ√°dn√° synchronizace!</strong>' : ''}
                            </div>
                        `;
                    } else if (lastSync.status === 'error') {
                        statusClass = 'error';
                        statusHtml = `
                            <div class="status error">
                                ‚ùå Posledn√≠ synchronizace selhala: ${formatDate(lastSync.started_at)} (${lastSyncTime})<br>
                                üîç Chyba: ${lastSync.error_message || 'Nezn√°m√° chyba'}
                            </div>
                        `;
                    }
                } else {
                    statusClass = 'warning';
                    statusHtml = '<div class="status warning">‚ö†Ô∏è Nenalezeny ≈æ√°dn√© z√°znamy o synchronizaci</div>';
                }

                document.getElementById('currentStatus').innerHTML = statusHtml;

                // Zobraz√≠me statistiky
                updateStats({
                    productCount: productCount || 0,
                    lastSyncDate: lastSync ? formatDate(lastSync.started_at) : 'Nikdy',
                    todaySyncs: todaySync ? todaySync.length : 0,
                    lastSyncStatus: lastSync ? lastSync.status : 'unknown'
                });

            } catch (error) {
                console.error('‚ùå Chyba p≈ôi kontrole stavu:', error);
                document.getElementById('currentStatus').innerHTML = `
                    <div class="status error">‚ùå Chyba p≈ôi kontrole stavu: ${error.message}</div>
                `;
            }
        }

        function updateStats(stats) {
            const container = document.getElementById('statsContainer');
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.productCount}</div>
                    <div class="stat-label">Produkt≈Ø v datab√°zi</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.todaySyncs}</div>
                    <div class="stat-label">Dne≈°n√≠ch synchronizac√≠</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.lastSyncStatus === 'success' ? '‚úÖ' : stats.lastSyncStatus === 'error' ? '‚ùå' : '‚ùì'}</div>
                    <div class="stat-label">Stav posledn√≠ sync</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="font-size: 1.2em">${stats.lastSyncDate}</div>
                    <div class="stat-label">Posledn√≠ synchronizace</div>
                </div>
            `;
        }

        async function loadSyncLogs() {
            try {
                console.log('üìã Naƒç√≠t√°m logy synchronizace...');
                
                const { data: logs, error } = await supabase
                    .from('sync_logs')
                    .select('*')
                    .like('sync_type', '%products%')
                    .order('started_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                let html = '';
                if (logs && logs.length > 0) {
                    logs.forEach(log => {
                        const statusEmoji = log.status === 'success' ? '‚úÖ' : log.status === 'error' ? '‚ùå' : '‚è≥';
                        const duration = log.finished_at ? 
                            Math.round((new Date(log.finished_at) - new Date(log.started_at)) / 1000) + 's' : 
                            'Neukonƒçeno';
                        
                        html += `
                            <div class="log-entry">
                                <span class="timestamp">${formatDate(log.started_at)}</span> 
                                ${statusEmoji} ${log.sync_type}
                                ${log.status === 'success' ? 
                                    `<br>üìä Zpracov√°no: ${log.records_processed || 0}, Nov√Ωch: ${log.records_inserted || 0}, Aktualizov√°no: ${log.records_updated || 0}, Chyb: ${log.records_failed || 0}` : 
                                    log.error_message ? `<br>‚ùå ${log.error_message}` : ''
                                }
                                <br><small>‚è±Ô∏è Trv√°n√≠: ${duration} | Feed: ${log.feed_url || 'N/A'}</small>
                            </div>
                        `;
                    });
                } else {
                    html = '<div class="status warning">‚ö†Ô∏è Nenalezeny ≈æ√°dn√© logy synchronizace</div>';
                }

                document.getElementById('syncLogs').innerHTML = html;

            } catch (error) {
                console.error('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ log≈Ø:', error);
                document.getElementById('syncLogs').innerHTML = `
                    <div class="status error">‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ log≈Ø: ${error.message}</div>
                `;
            }
        }

        async function testManualSync() {
            try {
                console.log('üß™ Testujem manu√°ln√≠ synchronizaci...');
                
                // Test p≈ôipojen√≠ k feedu
                const feedUrl = 'https://bewit.love/feeds/zbozi.xml';
                console.log('üì° Testujem p≈ôipojen√≠ k feedu:', feedUrl);
                
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(feedUrl)}`;
                const response = await fetch(proxyUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const xmlContent = await response.text();
                console.log('‚úÖ Feed je dostupn√Ω, velikost:', xmlContent.length, 'znak≈Ø');
                
                // Parsov√°n√≠ XML pro z√°kladn√≠ kontrolu
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlContent, 'text/xml');
                const parseError = xmlDoc.querySelector('parsererror');
                
                if (parseError) {
                    throw new Error('XML parsing error: ' + parseError.textContent);
                }
                
                const items = xmlDoc.querySelectorAll('item, SHOPITEM');
                console.log('üì¶ Nalezeno produkt≈Ø v feedu:', items.length);
                
                document.getElementById('manualActions').innerHTML = `
                    <div class="status success">
                        ‚úÖ Test manu√°ln√≠ synchronizace √∫spƒõ≈°n√Ω!<br>
                        üì° Feed je dostupn√Ω (${xmlContent.length} znak≈Ø)<br>
                        üì¶ Produkt≈Ø v feedu: ${items.length}<br>
                        üïí ${formatDate(new Date().toISOString())}
                    </div>
                `;
                
            } catch (error) {
                console.error('‚ùå Test manu√°ln√≠ synchronizace selhal:', error);
                document.getElementById('manualActions').innerHTML = `
                    <div class="status error">
                        ‚ùå Test manu√°ln√≠ synchronizace selhal:<br>
                        ${error.message}
                    </div>
                `;
            }
        }

        async function checkEdgeFunction() {
            try {
                console.log('‚ö° Testujem Edge Function...');
                
                const edgeFunctionUrl = 'https://modopafybeslbcqjxsve.supabase.co/functions/v1/sync-products';
                
                const response = await fetch(edgeFunctionUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const responseText = await response.text();
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch {
                    result = { raw: responseText };
                }
                
                if (response.ok) {
                    document.getElementById('manualActions').innerHTML = `
                        <div class="status success">
                            ‚úÖ Edge Function je funkƒçn√≠!<br>
                            üìä Odpovƒõƒè: ${JSON.stringify(result, null, 2)}<br>
                            üïí ${formatDate(new Date().toISOString())}
                        </div>
                    `;
                    
                    // Refresh log≈Ø a stavu
                    setTimeout(() => {
                        checkSyncStatus();
                        loadSyncLogs();
                    }, 2000);
                } else {
                    throw new Error(`HTTP ${response.status}: ${responseText}`);
                }
                
            } catch (error) {
                console.error('‚ùå Test Edge Function selhal:', error);
                document.getElementById('manualActions').innerHTML = `
                    <div class="status error">
                        ‚ùå Test Edge Function selhal:<br>
                        ${error.message}
                    </div>
                `;
            }
        }

        async function checkCronJobs() {
            try {
                console.log('‚è∞ Kontrolujem Cron Jobs...');
                
                // Pokus√≠me se naƒç√≠st pg_cron jobs (mo≈æn√° nebude fungovat kv≈Øli opr√°vnƒõn√≠m)
                const { data: cronJobs, error } = await supabase
                    .from('cron.job')
                    .select('*')
                    .ilike('jobname', '%sync%');
                
                if (error) {
                    // Pokud nem√°me p≈ô√≠stup k cron.job, zobraz√≠me instrukce
                    document.getElementById('manualActions').innerHTML = `
                        <div class="status warning">
                            ‚ö†Ô∏è Nelze p≈ô√≠mo zkontrolovat cron jobs z klienta.<br>
                            üìã Pro kontrolu spus≈•te v Supabase SQL editoru:<br>
                            <pre>SELECT jobname, schedule, active, last_run_start_time, last_run_status FROM cron.job WHERE jobname LIKE '%sync%';</pre>
                            
                            <h3>üîß Nastaven√≠ automatick√© synchronizace:</h3>
                            <p>Pokud cron job nen√≠ nastaven, p≈ôidejte ho pomoc√≠:</p>
                            <pre>SELECT cron.schedule(
  'sync-bewit-products-daily',
  '0 6 * * *',  -- Ka≈æd√Ω den v 6:00 r√°no
  'SELECT net.http_post(
    url := ''https://modopafybeslbcqjxsve.supabase.co/functions/v1/sync-products'',
    headers := jsonb_build_object(
      ''Authorization'', ''Bearer ${SUPABASE_ANON_KEY}'',
      ''Content-Type'', ''application/json''
    )
  );'
);</pre>
                        </div>
                    `;
                } else {
                    // Pokud se poda≈ôilo naƒç√≠st cron jobs
                    let cronHtml = '<h3>‚è∞ Nalezen√© Cron Jobs:</h3>';
                    if (cronJobs && cronJobs.length > 0) {
                        cronJobs.forEach(job => {
                            cronHtml += `
                                <div class="log-entry">
                                    üìÖ <strong>${job.jobname}</strong><br>
                                    ‚è∞ Rozvrh: ${job.schedule}<br>
                                    üîÑ Aktivn√≠: ${job.active ? 'Ano' : 'Ne'}<br>
                                    üïí Posledn√≠ bƒõh: ${formatDate(job.last_run_start_time)}<br>
                                    ‚úÖ Stav: ${job.last_run_status || 'Nezn√°m√Ω'}
                                </div>
                            `;
                        });
                    } else {
                        cronHtml += '<div class="status warning">‚ö†Ô∏è Nenalezeny ≈æ√°dn√© cron jobs pro synchronizaci</div>';
                    }
                    
                    document.getElementById('manualActions').innerHTML = cronHtml;
                }
                
            } catch (error) {
                console.error('‚ùå Kontrola cron jobs selhala:', error);
                document.getElementById('manualActions').innerHTML = `
                    <div class="status error">
                        ‚ùå Kontrola cron jobs selhala: ${error.message}
                    </div>
                `;
            }
        }

        async function forceSyncNow() {
            const btn = document.getElementById('forceSyncBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Synchronizuji...';
            
            try {
                await checkEdgeFunction();
            } finally {
                btn.disabled = false;
                btn.textContent = 'üöÄ Vynutit okam≈æitou synchronizaci';
            }
        }

        async function clearOldLogs() {
            try {
                console.log('üóëÔ∏è Ma≈æu star√© logy...');
                
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                const { error } = await supabase
                    .from('sync_logs')
                    .delete()
                    .lt('started_at', thirtyDaysAgo.toISOString());
                
                if (error) throw error;
                
                document.getElementById('manualActions').innerHTML = `
                    <div class="status success">
                        ‚úÖ Star√© logy (>30 dn√≠) byly vymaz√°ny<br>
                        üïí ${formatDate(new Date().toISOString())}
                    </div>
                `;
                
                // Refresh log≈Ø
                await loadSyncLogs();
                
            } catch (error) {
                console.error('‚ùå Maz√°n√≠ log≈Ø selhalo:', error);
                document.getElementById('manualActions').innerHTML = `
                    <div class="status error">
                        ‚ùå Maz√°n√≠ log≈Ø selhalo: ${error.message}
                    </div>
                `;
            }
        }

        async function runDiagnostics() {
            try {
                console.log('üìà Spou≈°t√≠m diagnostiku...');
                
                const diagnostics = {
                    timestamp: new Date().toISOString(),
                    supabase_url: SUPABASE_URL,
                    edge_function_url: 'https://modopafybeslbcqjxsve.supabase.co/functions/v1/sync-products',
                    feed_url: 'https://bewit.love/feeds/zbozi.xml',
                    browser: navigator.userAgent,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    local_time: new Date().toLocaleString('cs-CZ')
                };
                
                // Test p≈ôipojen√≠ k Supabase
                try {
                    const { data, error } = await supabase.from('products').select('count').limit(1);
                    diagnostics.supabase_connection = error ? `‚ùå ${error.message}` : '‚úÖ OK';
                } catch (error) {
                    diagnostics.supabase_connection = `‚ùå ${error.message}`;
                }
                
                // Test dostupnosti feedu
                try {
                    const response = await fetch('https://api.allorigins.win/raw?url=https://bewit.love/feeds/zbozi.xml');
                    diagnostics.feed_accessibility = response.ok ? '‚úÖ OK' : `‚ùå HTTP ${response.status}`;
                } catch (error) {
                    diagnostics.feed_accessibility = `‚ùå ${error.message}`;
                }
                
                document.getElementById('diagnostics').textContent = JSON.stringify(diagnostics, null, 2);
                
            } catch (error) {
                console.error('‚ùå Diagnostika selhala:', error);
                document.getElementById('diagnostics').textContent = `‚ùå Diagnostika selhala: ${error.message}`;
            }
        }
    </script>
</body>
</html>
